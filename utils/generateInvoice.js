const fs = require("fs");
const path = require("path");
const PDFDocument = require("pdfkit");
const QRCode = require("qrcode");

const generateInvoice = async (booking, listing, guest) => {
  return new Promise(async (resolve, reject) => {
    const invoiceDir = path.join(__dirname, "../invoices");
    if (!fs.existsSync(invoiceDir))
      fs.mkdirSync(invoiceDir, { recursive: true });

    const filePath = path.join(invoiceDir, `invoice-${booking._id}.pdf`);
    const qrPath = path.join(invoiceDir, `qr-${booking._id}.png`);
    const doc = new PDFDocument({ size: "A4", margin: 50 });

    const stream = fs.createWriteStream(filePath);
    doc.pipe(stream);

    const width = doc.page.width;
    const usableWidth = width - 100;

    // ✅ Load Bangla font
    const banglaFontPath = path.join(
      __dirname,
      "../fonts/NotoSansBengali-VariableFont_wdth,wght.ttf"
    );
    if (fs.existsSync(banglaFontPath))
      doc.registerFont("Bangla", banglaFontPath);

    // ✅ Draw header background
    doc.rect(0, 0, width, 100).fill("#f0fdf4");

    // ✅ Add logo (adjust Y to avoid overlapping)
    const logoPath = path.join(__dirname, "../assets/banglabnb-logo.png");
    if (fs.existsSync(logoPath)) {
      doc.image(logoPath, 50, 30, { width: 80 });
    }

    // ✅ Header Text
    doc
      .fillColor("#006a4e")
      .fontSize(24)
      .text("BanglaBnB", 0, 40, { align: "right", width: usableWidth });

    doc
      .fontSize(14)
      .fillColor("#d21034")
      .text("📄 Booking Invoice", { align: "right" });

    doc.moveDown().moveTo(50, 110).lineTo(550, 110).stroke();

    // ✅ Booking Info Section
    doc.moveDown();
    const nights = Math.ceil(
      (new Date(booking.dateTo) - new Date(booking.dateFrom)) /
        (1000 * 60 * 60 * 24)
    );
    const baseRate = listing.price;
    const serviceFee = 100;
    const total = baseRate * nights + serviceFee;
    const formatCurrency = (value) => `BDT ${value.toFixed(2)}`;

    doc
      .fillColor("black")
      .fontSize(12)
      .text(`Booking ID: ${booking._id}`)
      .text(`Guest: ${guest.name} (${guest.email})`)
      .text(`Listing: ${listing.title}`)
      .text(`Location: ${listing.location?.address}`)
      .text(
        `Dates: ${new Date(booking.dateFrom).toLocaleDateString()} → ${new Date(
          booking.dateTo
        ).toLocaleDateString()}`
      )
      .text(`Payment Status: ${booking.paymentStatus}`)
      .moveDown();

    // ✅ Bangla Translation
    doc
      .font("Bangla")
      .fillColor("#333")
      .fontSize(11)
      .text(`অতিথি: ${guest.name}`, { continued: true })
      .text(`  •  মেইল: ${guest.email}`)
      .text(`স্থান: ${listing.location?.address}`)
      .text(
        `তারিখ: ${new Date(booking.dateFrom).toLocaleDateString()} → ${new Date(
          booking.dateTo
        ).toLocaleDateString()}`
      )
      .moveDown();

    // ✅ Price Breakdown Section
    doc.rect(50, doc.y - 10, usableWidth, 100).fill("#fef3c7");
    doc
      .fillColor("black")
      .font("Helvetica")
      .fontSize(13)
      .text("💵 Price Breakdown", 60, doc.y + 10, { underline: true });

    doc
      .fontSize(12)
      .text(`Nightly Rate (${nights} nights x BDT ${baseRate}):`, 60)
      .text(formatCurrency(baseRate * nights), 0, doc.y, { align: "right" })
      .text(`Service Fee:`, 60)
      .text(formatCurrency(serviceFee), 0, doc.y, { align: "right" })
      .font("Helvetica-Bold")
      .text(`Total Amount Paid:`, 60)
      .text(formatCurrency(total), 0, doc.y, { align: "right" });

    // ✅ Invoice Footer
    doc.moveDown(2);
    doc
      .font("Helvetica")
      .fontSize(11)
      .fillColor("gray")
      .text(`Invoice Number: INV-${booking._id}`)
      .text(`Issued on: ${new Date().toLocaleDateString()}`);

    // ✅ Generate QR and place it
    await QRCode.toFile(
      qrPath,
      `https://banglabnb.com/bookings/${booking._id}`,
      { width: 100 }
    );
    doc.image(qrPath, 450, doc.y - 40, { width: 80 });

    // ✅ Footer background
    const footerY = doc.y + 80;
    doc.rect(0, footerY, width, 50).fill("#f0f0f0");
    doc
      .fillColor("#444")
      .fontSize(10)
      .text(
        "This invoice was automatically generated by BanglaBnB",
        0,
        footerY + 20,
        { align: "center" }
      );

    doc.end();

    stream.on("finish", () => {
      resolve(filePath);
      fs.unlink(qrPath, () => {});
    });

    stream.on("error", reject);
  });
};

module.exports = generateInvoice;
