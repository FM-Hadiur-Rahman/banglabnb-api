const fs = require("fs");
const path = require("path");
const PDFDocument = require("pdfkit");
const QRCode = require("qrcode");

const generateInvoice = async (booking, listing, guest) => {
  return new Promise(async (resolve, reject) => {
    const invoiceDir = path.join(__dirname, "../invoices");
    if (!fs.existsSync(invoiceDir))
      fs.mkdirSync(invoiceDir, { recursive: true });

    const filePath = path.join(invoiceDir, `invoice-${booking._id}.pdf`);
    const qrPath = path.join(invoiceDir, `qr-${booking._id}.png`);
    const doc = new PDFDocument({ size: "A4", margin: 50 });

    const stream = fs.createWriteStream(filePath);
    doc.pipe(stream);

    // Fonts and assets
    const logoPath = path.join(__dirname, "../assets/banglabnb-logo.png");
    const banglaFontPath = path.join(
      __dirname,
      "../fonts/NotoSansBengali-VariableFont_wdth,wght.ttf"
    );
    if (fs.existsSync(banglaFontPath))
      doc.registerFont("Bangla", banglaFontPath);

    // Header Background
    doc.rect(0, 0, doc.page.width, 100).fill("#e6f2f0");
    if (fs.existsSync(logoPath)) doc.image(logoPath, 50, 30, { width: 80 });

    doc
      .fillColor("#006a4e")
      .fontSize(22)
      .font("Helvetica-Bold")
      .text("BanglaBnB", 0, 40, { align: "right", width: 500 })
      .fontSize(14)
      .fillColor("#d21034")
      .text("ðŸ“„ Booking Invoice", { align: "right", width: 500 });

    doc.moveTo(50, 110).lineTo(550, 110).stroke();

    // Calculations
    const nights = Math.ceil(
      (new Date(booking.dateTo) - new Date(booking.dateFrom)) /
        (1000 * 60 * 60 * 24)
    );
    const baseRate = listing.price;
    const baseTotal = baseRate * nights;
    const serviceFee = baseTotal * 0.1;
    const tax = (baseTotal + serviceFee) * 0.1;
    const total = baseTotal + serviceFee + tax;

    const formatBDT = (val) => `BDT ${val.toFixed(2)}`;

    // Booking Details Box
    doc
      .rect(50, 120, 500, 100)
      .fill("#f8f8f8")
      .stroke()
      .fillColor("black")
      .font("Helvetica")
      .fontSize(11);

    const infoTop = 130;
    doc
      .text(`Booking ID: ${booking._id}`, 60, infoTop)
      .text(`Guest: ${guest.name} (${guest.email})`, 60)
      .text(`Listing: ${listing.title}`, 60)
      .text(`Address: ${listing.location?.address}`, 60)
      .text(
        `Dates: ${new Date(booking.dateFrom).toLocaleDateString()} â†’ ${new Date(
          booking.dateTo
        ).toLocaleDateString()}`,
        60
      )
      .text(`Status: ${booking.paymentStatus}`, 60);

    // Bangla Translation Section
    doc.moveDown().font("Bangla").fillColor("#444").fontSize(11);
    doc
      .text(`à¦…à¦¤à¦¿à¦¥à¦¿: ${guest.name}`)
      .text(`à¦®à§‡à¦‡à¦²: ${guest.email}`)
      .text(`à¦…à¦¬à¦¸à§à¦¥à¦¾à¦¨: ${listing.location?.address}`)
      .text(
        `à¦¤à¦¾à¦°à¦¿à¦–: ${new Date(booking.dateFrom).toLocaleDateString()} â†’ ${new Date(
          booking.dateTo
        ).toLocaleDateString()}`
      );

    // Payment Summary
    doc
      .moveDown()
      .font("Helvetica-Bold")
      .fillColor("black")
      .fontSize(13)
      .text("ðŸ’µ Payment Summary", { underline: true });
    doc.font("Helvetica").fontSize(12);

    const left = 60,
      right = 500;
    doc
      .text(`Nightly Rate (${formatBDT(baseRate)} Ã— ${nights} nights):`, left)
      .text(formatBDT(baseTotal), right, doc.y, { align: "right" })
      .text("Service Fee (10%):", left)
      .text(formatBDT(serviceFee), right, doc.y, { align: "right" })
      .text("VAT (10%):", left)
      .text(formatBDT(tax), right, doc.y, { align: "right" })
      .font("Helvetica-Bold")
      .text("Total Amount Paid:", left)
      .text(formatBDT(total), right, doc.y, { align: "right" });

    // Invoice Meta
    doc.moveDown().font("Helvetica").fontSize(11).fillColor("gray");
    doc.text(`Invoice Number: INV-${booking._id}`);
    doc.text(`Issued on: ${new Date().toLocaleDateString("en-GB")}`);

    // QR Code
    await QRCode.toFile(
      qrPath,
      `https://banglabnb.com/bookings/${booking._id}`,
      { width: 100 }
    );
    doc.image(qrPath, 450, doc.y - 40, { width: 80 });

    // Signature Section
    doc.moveDown(6).fontSize(12).fillColor("black");
    doc.text("__________________________", 60);
    doc.text("Guest Signature", 60);
    doc.text("__________________________", 350);
    doc.text("Authorized Signature", 350);

    // Footer Strip
    doc.rect(0, 760, doc.page.width, 40).fill("#f0f0f0");
    doc
      .fillColor("gray")
      .fontSize(10)
      .text("This invoice was generated by BanglaBnB", 50, 775, {
        align: "center",
      });

    // Watermark (optional)
    // doc.opacity(0.05).fontSize(80).rotate(45, { origin: [300, 400] }).text("BanglaBnB", 100, 300);

    doc.end();

    stream.on("finish", () => {
      resolve(filePath);
      fs.unlink(qrPath, () => {});
    });

    stream.on("error", reject);
  });
};

module.exports = generateInvoice;
