const fs = require("fs");
const path = require("path");
const PDFDocument = require("pdfkit");
const QRCode = require("qrcode");

const generateTripInvoice = async (reservation, trip, user) => {
  const invoiceDir = path.join(__dirname, "../invoices");
  if (!fs.existsSync(invoiceDir)) fs.mkdirSync(invoiceDir, { recursive: true });

  const filePath = path.join(invoiceDir, `trip-invoice-${reservation._id}.pdf`);
  const doc = new PDFDocument({ size: "A4", margin: 50 });
  const stream = fs.createWriteStream(filePath);
  doc.pipe(stream);

  // âœ… Watermark
  doc
    .fontSize(60)
    .fillColor("gray")
    .opacity(0.2)
    .rotate(45, { origin: [250, 300] })
    .text("BanglaBnB", 100, 150);
  doc.rotate(-45).opacity(1); // reset

  // âœ… Header with logo
  const logoPath = path.join(__dirname, "../assets/banglabnb-logo.png");
  if (fs.existsSync(logoPath)) {
    doc.image(logoPath, 50, 40, { width: 100 });
  }

  doc
    .fontSize(18)
    .fillColor("black")
    .text("ðŸ§¾ Trip Reservation Invoice", 200, 50);

  // âœ… Reservation details
  doc.fontSize(12).moveDown().text(`Invoice ID: ${reservation._id}`);
  doc.text(`Passenger: ${user.name}`);
  doc.text(`Trip: ${trip.from} âž¡ ${trip.to}`);
  doc.text(`Date: ${trip.date}`);
  doc.text(`Time: ${trip.time}`);
  doc.text(`Seats Reserved: ${reservation.numberOfSeats}`);
  doc.text(`Fare per Seat: à§³${reservation.farePerSeat}`);
  doc.text(`Total Paid: à§³${reservation.totalAmount}`);

  // âœ… QR Code
  const qrData = `Trip ID: ${trip._id}, Reservation ID: ${reservation._id}, Amount: à§³${reservation.totalAmount}`;
  const qrImage = await QRCode.toDataURL(qrData);
  doc.image(qrImage, 400, 250, { width: 100 });

  // âœ… Footer
  doc.moveDown(4);
  doc.fontSize(10).fillColor("gray").text("Generated by BanglaBnB", {
    align: "center",
  });

  doc.end();

  return new Promise((resolve, reject) => {
    stream.on("finish", () => resolve(filePath));
    stream.on("error", reject);
  });
};

module.exports = generateTripInvoice;
